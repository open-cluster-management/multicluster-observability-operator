apiVersion: apps/v1
kind: Deployment
metadata:
  name: __CLUSTER_NAME__-metrics-collector-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      component: metrics-collector
  template:
    metadata:
      labels:
        component: metrics-collector
    spec:
      containers:
      - command:
        - /usr/bin/telemeter-client
        - --id=$(ID)
        - --from=$(FROM)
        - --to-upload=$(TO)
        - --from-ca-file=/etc/serving-certs-ca-bundle/service-ca.crt
        - --from-token-file=/var/run/secrets/kubernetes.io/serviceaccount/token
        - --interval=60s
        - --label="cluster=__CLUSTER_NAME__"
        - --label="clusterID=__CLUSTER_NAME__-id"
        - --limit-bytes=52428800
        - --match={__name__=":node_memory_MemAvailable_bytes:sum"}
        - --match={__name__="apiserver_request_count"}
        - --match={__name__="apiserver_request_duration_seconds_bucket"}
        - --match={__name__="apiserver_request_duration_seconds_count"}
        - --match={__name__="apiserver_request_duration_seconds_sum"}
        - --match={__name__="apiserver_request_latencies_summary_count"}
        - --match={__name__="apiserver_request_latencies_summary_sum"}
        - --match={__name__="apiserver_request_total"}
        - --match={__name__="cluster:capacity_cpu_cores:sum"}
        - --match={__name__="cluster:capacity_memory_bytes:sum"}
        - --match={__name__="cluster:container_cpu_usage:ratio"}
        - --match={__name__="cluster:container_spec_cpu_shares:ratio"}
        - --match={__name__="cluster:cpu_usage_cores:sum"}
        - --match={__name__="cluster:memory_usage:ratio"}
        - --match={__name__="cluster:memory_usage_bytes:sum"}
        - --match={__name__="cluster:usage:resources:sum"}
        - --match={__name__="cluster_infrastructure_provider"}
        - --match={__name__="cluster_version"}
        - --match={__name__="cluster_version_payload"}
        - --match={__name__="container_cpu_cfs_throttled_periods_total"}
        - --match={__name__="container_cpu_usage_seconds_total"}
        - --match={__name__="container_fs_limit_bytes"}
        - --match={__name__="container_fs_usage_bytes"}
        - --match={__name__="container_memory_cache"}
        - --match={__name__="container_memory_rss"}
        - --match={__name__="container_memory_swap"}
        - --match={__name__="container_memory_working_set_bytes"}
        - --match={__name__="container_network_receive_bytes_total"}
        - --match={__name__="container_network_receive_packets_dropped_total"}
        - --match={__name__="container_network_receive_packets_total"}
        - --match={__name__="container_network_transmit_bytes_total"}
        - --match={__name__="container_network_transmit_packets_dropped_total"}
        - --match={__name__="container_network_transmit_packets_total"}
        - --match={__name__="container_spec_cpu_quota"}
        - --match={__name__="etcd_debugging_mvcc_db_total_size_in_bytes"}
        - --match={__name__="etcd_debugging_snap_save_total_duration_seconds_sum"}
        - --match={__name__="etcd_disk_backend_commit_duration_seconds_bucket"}
        - --match={__name__="etcd_disk_backend_commit_duration_seconds_sum"}
        - --match={__name__="etcd_disk_wal_fsync_duration_seconds_bucket"}
        - --match={__name__="etcd_disk_wal_fsync_duration_seconds_sum"}
        - --match={__name__="etcd_network_client_grpc_received_bytes_total"}
        - --match={__name__="etcd_network_client_grpc_sent_bytes_total"}
        - --match={__name__="etcd_network_peer_received_bytes_total"}
        - --match={__name__="etcd_network_peer_sent_bytes_total"}
        - --match={__name__="etcd_server_has_leader"}
        - --match={__name__="etcd_server_leader_changes_seen_total"}
        - --match={__name__="etcd_server_proposals_failed_total"}
        - --match={__name__="etcd_server_proposals_pending"}
        - --match={__name__="etcd_server_proposals_committed_total"}
        - --match={__name__="etcd_server_proposals_applied_total"}
        - --match={__name__="etcd_server_quota_backend_bytes"}
        - --match={__name__="go_goroutines"}
        - --match={__name__="grpc_server_started_total"}
        - --match={__name__="grpc_server_handled_total"}
        - --match={__name__="haproxy_backend_connections_total"}
        - --match={__name__="http_requests_total"}
        - --match={__name__="instance:node_filesystem_usage:sum"}
        - --match={__name__="instance:node_cpu_utilisation:rate1m"}
        - --match={__name__="instance:node_load1_per_cpu:ratio"}
        - --match={__name__="instance:node_memory_utilisation:ratio"}
        - --match={__name__="instance:node_network_receive_bytes_excluding_lo:rate1m"}
        - --match={__name__="instance:node_network_receive_drop_excluding_lo:rate1m"}
        - --match={__name__="instance:node_network_transmit_bytes_excluding_lo:rate1m"}
        - --match={__name__="instance:node_network_transmit_drop_excluding_lo:rate1m"}
        - --match={__name__="instance:node_num_cpu:sum"}
        - --match={__name__="instance:node_vmstat_pgmajfault:rate1m"}
        - --match={__name__="instance_device:node_disk_io_time_seconds:rate1m"}
        - --match={__name__="instance_device:node_disk_io_time_weighted_seconds:rate1m"}
        - --match={__name__="kube_daemonset_status_desired_number_scheduled"}
        - --match={__name__="kube_daemonset_status_number_unavailable"}
        - --match={__name__="kube_deployment_status_replicas_unavailable"}
        - --match={__name__="kube_node_spec_unschedulable"}
        - --match={__name__="kube_node_status_allocatable_cpu_cores"}
        - --match={__name__="kube_node_status_allocatable_memory_bytes"}
        - --match={__name__="kube_node_status_capacity_pods"}
        - --match={__name__="kube_node_status_capacity_cpu_cores"}
        - --match={__name__="kube_node_status_condition"}
        - --match={__name__="kube_pod_container_resource_limits_cpu_cores"}
        - --match={__name__="kube_pod_container_resource_limits_memory_bytes"}
        - --match={__name__="kube_pod_container_resource_requests_cpu_cores"}
        - --match={__name__="kube_pod_container_resource_requests_memory_bytes"}
        - --match={__name__="kube_pod_container_status_last_terminated_reason"}
        - --match={__name__="kube_pod_container_status_ready"}
        - --match={__name__="kube_pod_container_status_restarts_total"}
        - --match={__name__="kube_pod_container_status_terminated_reason"}
        - --match={__name__="kube_pod_container_status_waiting"}
        - --match={__name__="kube_pod_info"}
        - --match={__name__="kube_pod_status_ready"}
        - --match={__name__="kube_pod_status_phase"}
        - --match={__name__="kube_resourcequota"}
        - --match={__name__="kubelet_running_container_count"}
        - --match={__name__="kubelet_runtime_operations"}
        - --match={__name__="kubelet_runtime_operations_latency_microseconds"}
        - --match={__name__="machine_cpu_cores"}
        - --match={__name__="machine_memory_bytes"}
        - --match={__name__="mixin_pod_workload"}
        - --match={__name__="namespace:kube_pod_container_resource_requests_cpu_cores:sum"}
        - --match={__name__="namespace:kube_pod_container_resource_requests_memory_bytes:sum"}
        - --match={__name__="namespace:container_memory_usage_bytes:sum"}
        - --match={__name__="node_cpu_seconds_total"}
        - --match={__name__="node_filesystem_avail_bytes"}
        - --match={__name__="node_filesystem_free_bytes"}
        - --match={__name__="node_filesystem_size_bytes"}
        - --match={__name__="node_memory_MemAvailable_bytes"}
        - --match={__name__="node_namespace_pod_container:container_cpu_usage_seconds_total:sum_rate"}
        - --match={__name__="node_namespace_pod_container:container_memory_cache"}
        - --match={__name__="node_namespace_pod_container:container_memory_rss"}
        - --match={__name__="node_namespace_pod_container:container_memory_swap"}
        - --match={__name__="node_namespace_pod_container:container_memory_working_set_bytes"}
        - --match={__name__="node_netstat_Tcp_OutSegs"}
        - --match={__name__="node_netstat_Tcp_RetransSegs"}
        - --match={__name__="node_netstat_TcpExt_TCPSynRetrans"}
        - --match={__name__="process_cpu_seconds_total"}
        - --match={__name__="process_resident_memory_bytes"}
        - --match={__name__="rest_client_request_latency_seconds_bucket"}
        - --match={__name__="rest_client_requests_total"}
        - --match={__name__="up"}
        - --match={__name__="workqueue_adds_total"}
        - --match={__name__="workqueue_depth"}
        - --match={__name__="workqueue_queue_duration_seconds_bucket"}
        env:
        - name: FROM
          value: __FROM__
        - name: TO
          value: __TO__
        - name: ID
          value: __CLUSTER_NAME__-id
        image: __IMAGE__
        imagePullPolicy: IfNotPresent
        name: metrics-collector
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /etc/serving-certs-ca-bundle
          name: serving-certs-ca-bundle
        - mountPath: /tlscerts
          name: observability-managed-cluster-certs
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: endpoint-observability-operator-sa
      serviceAccountName: endpoint-observability-operator-sa
      terminationGracePeriodSeconds: 30
      volumes:
      - configMap:
          defaultMode: 420
          name: metrics-collector-serving-certs-ca-bundle
        name: serving-certs-ca-bundle
      - name: observability-managed-cluster-certs
        secret:
          defaultMode: 420
          secretName: observability-managed-cluster-certs
